{
	"name": "SQL Load script",
	"properties": {
		"content": {
			"query": "MERGE dbo.DimBattalion AS TGT\nUSING (\n    SELECT ROW_NUMBER() OVER (ORDER BY battalion_code) battalion_id, battalion_code, battalion_name from (\n    select distinct battalion battalion_code,\n    SUBSTRING(battalion,1,1) + ' ' + SUBSTRING(battalion,2,3) battalion_name\n    from dbo.Raw_FireIncidents) x\n    ) AS SRC (battalion_id, battalion_code, battalion_name)\nON TGT.battalion_code = SRC.battalion_code\n    WHEN MATCHED THEN\n        UPDATE SET battalion_name = src.battalion_name  \n    WHEN NOT MATCHED THEN  \n        INSERT (battalion_id, battalion_code, battalion_name)\n        VALUES (src.battalion_id,src.battalion_code, src.battalion_name) ;\n\nMERGE dbo.DimDistrict AS TGT\nUSING (\n    SELECT ROW_NUMBER() OVER (ORDER BY district_name) district_id, district_name from (\n    select distinct neighborhood_district district_name\n    from dbo.Raw_FireIncidents\n    ) x\n    ) AS SRC (district_id, district_name)\nON TGT.district_name = SRC.district_name\n    WHEN MATCHED THEN\n        UPDATE SET district_id = src.district_id  \n    WHEN NOT MATCHED THEN  \n        INSERT (district_id, district_name)\n        VALUES (src.district_id, src.district_name) ;\n\nMERGE dbo.FactFireIncidents AS TGT\nUSING (\n    SELECT incident_number, exposure_number, id, address, incident_date, call_number, alarm_dttm, \n        arrival_dttm, close_dttm, city, zipcode, db.battalion_id, station_area, box, suppression_units, \n        suppression_personnel, ems_units, ems_personnel, other_units, other_personnel, first_unit_on_scene, \n        estimated_property_loss, estimated_contents_loss, fire_fatalities, fire_injuries, civilian_fatalities, \n        civilian_injuries, number_of_alarms, primary_situation, mutual_aid, dap.action_id, das.action_id\n        , action_taken_other, detector_alerted_occupants, property_use, \n        daf.area_id, ignition_cause, ignition_factor_primary, ignition_factor_secondary, \n        heat_source, item_first_ignited, human_factors_associated_with_ignition, structure_type, \n        structure_status, floor_of_fire_origin, fire_spread, no_flame_spead, number_of_floors_with_minimum_damage, \n        number_of_floors_with_significant_damage, number_of_floors_with_heavy_damage, number_of_floors_with_extreme_damage, \n        detectors_present, detector_type, detector_operation, detector_effectiveness, detector_failure_reason, \n        automatic_extinguishing_system_present, automatic_extinguishing_sytem_type, automatic_extinguishing_sytem_perfomance, \n        automatic_extinguishing_sytem_failure_reason, number_of_sprinkler_heads_operating, supervisor_district, neighborhood_district_id_fk\n    from dbo.Raw_FireIncidents rfi\n    LEFT JOIN dbo.DimAction dap\n        on dap.action_code = substring(rfi.action_taken_primary,case when LEN(rfi.action_taken_primary) > 0 THEN 1 ELSE 0 END,case when TRIM(rfi.action_taken_primary) = '-' then 1 \n            else CHARINDEX('-',rfi.action_taken_primary)-2 end) \n    LEFT JOIN dbo.DimAction das\n        on das.action_code = substring(rfi.action_taken_secondary,case when LEN(rfi.action_taken_secondary) > 0 THEN 1 ELSE 0 END,case when TRIM(rfi.action_taken_secondary) = '-' then 1 \n            else CHARINDEX('-',rfi.action_taken_secondary)-2 end)\n    LEFT JOIN dbo.DimAreaOfFireOrigin daf\n        on daf.area_code = substring(rfi.area_of_fire_origin,1,CHARINDEX('-',rfi.area_of_fire_origin)-2)\n    LEFT JOIN dbo.DimDistrict dd\n        on dd.district_name = rfi.neighborhood_district\n    LEFT JOIN dbo.DimBattalion db\n        on db.battalion_code = rfi.battalion\n    ) AS SRC (district_id, district_name)\nON TGT.district_name = SRC.district_name\n    WHEN MATCHED THEN\n        UPDATE SET district_id = src.district_id  \n    WHEN NOT MATCHED THEN  \n        INSERT (incident_number, exposure_number, id, address, incident_date, call_number, alarm_dttm, \n        arrival_dttm, close_dttm, city, zipcode, battalion_id_fk, station_area, box, suppression_units, \n        suppression_personnel, ems_units, ems_personnel, other_units, other_personnel, first_unit_on_scene, \n        estimated_property_loss, estimated_contents_loss, fire_fatalities, fire_injuries, civilian_fatalities, \n        civilian_injuries, number_of_alarms, primary_situation, mutual_aid, action_taken_primary_id_fk, \n        action_taken_secondary_id_fk, action_taken_other, detector_alerted_occupants, property_use, \n        area_of_fire_origin_id_fk, ignition_cause, ignition_factor_primary, ignition_factor_secondary, \n        heat_source, item_first_ignited, human_factors_associated_with_ignition, structure_type, \n        structure_status, floor_of_fire_origin, fire_spread, no_flame_spead, number_of_floors_with_minimum_damage, \n        number_of_floors_with_significant_damage, number_of_floors_with_heavy_damage, number_of_floors_with_extreme_damage, \n        detectors_present, detector_type, detector_operation, detector_effectiveness, detector_failure_reason, \n        automatic_extinguishing_system_present, automatic_extinguishing_sytem_type, automatic_extinguishing_sytem_perfomance, \n        automatic_extinguishing_sytem_failure_reason, number_of_sprinkler_heads_operating, supervisor_district, neighborhood_district_id_fk)\n        VALUES (src.district_id, src.district_name) ;\n\n/*\nselect * from dbo.DimDistrict\nselect distinct area_of_fire_origin \nfrom dbo.Raw_FireIncidents\nwhere TRIM(area_of_fire_origin) <> '-'\n*/\n\nMERGE dbo.DimAction AS TGT\nUSING (\n    SELECT ROW_NUMBER() OVER (ORDER BY action_code) action_id,action_code,action_name from (\n--insert into dbo.DimAction (action_id, action_name)\n        select distinct substring(action_taken_secondary,1,CHARINDEX('-',action_taken_secondary)-2) action_code\n        ,substring(action_taken_secondary,CHARINDEX('-',action_taken_secondary)+2,LEN(action_taken_secondary)-1) action_name \n        from dbo.Raw_FireIncidents\n        where TRIM(action_taken_secondary) <> '-'\n        UNION ALL\n        select distinct substring(action_taken_primary,1,CHARINDEX('-',action_taken_primary)-2) action_code\n        ,substring(action_taken_primary,CHARINDEX('-',action_taken_primary)+2,LEN(action_taken_primary)-1) action_name from dbo.Raw_FireIncidents\n        where TRIM(action_taken_primary) <> '-'\n        ) x\n    ) AS SRC (action_id, action_code, action_name)\nON TGT.action_code = SRC.action_code\n    WHEN MATCHED THEN\n        UPDATE SET action_name = src.action_name  \n    WHEN NOT MATCHED THEN  \n        INSERT (action_id,action_code, action_name) \n        VALUES (src.action_id,src.action_code, src.action_name) ;\n\n\nMERGE dbo.DimAreaOfFireOrigin AS TGT\nUSING (\n    select distinct ROW_NUMBER() OVER (ORDER BY substring(area_of_fire_origin,1,CHARINDEX('-',area_of_fire_origin)-2)) area_id, \n    substring(area_of_fire_origin,1,CHARINDEX('-',area_of_fire_origin)-2) area_code\n    ,substring(area_of_fire_origin,CHARINDEX('-',area_of_fire_origin)+2,LEN(area_of_fire_origin)-1) area_name \n    from dbo.Raw_FireIncidents\n    where TRIM(area_of_fire_origin) <> '-'\n) AS SRC (area_id,area_code, area_name)\nON TGT.area_code = SRC.area_code\n    WHEN MATCHED THEN\n        UPDATE SET area_name = src.area_name  \n    WHEN NOT MATCHED THEN  \n        INSERT (area_id, area_code, area_name) \n        VALUES (src.area_id, src.area_code, src.area_name) ;\n\n        select * from dbo.DimAreaOfFireOrigin order by 1\nSET IDENTITY_INSERT dbo.DimAreaOfFireOrigin OFF;\n\nSET IDENTITY_INSERT dbo.DimAction ON;\n--insert into dbo.DimAction (action_id, action_name)\nSET IDENTITY_INSERT dbo.DimAction OFF;\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "SQLPoolTest",
				"poolName": "SQLPoolTest"
			},
			"resultLimit": -1
		},
		"type": "SqlQuery"
	}
}