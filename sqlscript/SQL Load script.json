{
	"name": "SQL Load script",
	"properties": {
		"content": {
			"query": "ALTER PROCEDURE dbo.LoadDimAndFact AS\nBEGIN\n    MERGE dbo.DimBattalion AS TGT\n    USING (\n        SELECT ROW_NUMBER() OVER (ORDER BY battalion_code) battalion_id, battalion_code, battalion_name from (\n            select distinct battalion battalion_code,\n            SUBSTRING(battalion,1,1) + ' ' + SUBSTRING(battalion,2,3) battalion_name\n            from dbo.Raw_FireIncidents) x\n        ) AS SRC (battalion_id, battalion_code, battalion_name)\n    ON TGT.battalion_code = SRC.battalion_code\n        WHEN MATCHED THEN\n            UPDATE SET battalion_name = src.battalion_name  \n        WHEN NOT MATCHED THEN  \n            INSERT (battalion_id, battalion_code, battalion_name)\n            VALUES (src.battalion_id,src.battalion_code, src.battalion_name);\n\n    MERGE dbo.DimDistrict AS TGT\n    USING (\n        SELECT ROW_NUMBER() OVER (ORDER BY district_name) district_id, district_name from (\n            select distinct neighborhood_district district_name\n            from dbo.Raw_FireIncidents\n            ) x\n        ) AS SRC (district_id, district_name)\n    ON TGT.district_name = SRC.district_name\n        WHEN MATCHED THEN\n            UPDATE SET district_id = src.district_id  \n        WHEN NOT MATCHED THEN  \n            INSERT (district_id, district_name)\n            VALUES (src.district_id, src.district_name) ;\n\n    MERGE dbo.DimAction AS TGT\n    USING (\n        SELECT ROW_NUMBER() OVER (ORDER BY action_code) action_id,action_code,action_name from (\n            select distinct substring(action_taken_secondary,1,CHARINDEX('-',action_taken_secondary)-2) action_code\n            ,substring(action_taken_secondary,CHARINDEX('-',action_taken_secondary)+2,LEN(action_taken_secondary)-1) action_name \n            from dbo.Raw_FireIncidents\n            where TRIM(action_taken_secondary) <> '-'\n            UNION\n            select distinct substring(action_taken_primary,1,CHARINDEX('-',action_taken_primary)-2) action_code\n            ,substring(action_taken_primary,CHARINDEX('-',action_taken_primary)+2,LEN(action_taken_primary)-1) action_name from dbo.Raw_FireIncidents\n            where TRIM(action_taken_primary) <> '-'\n            ) x\n        ) AS SRC (action_id, action_code, action_name)\n    ON TGT.action_code = SRC.action_code\n        WHEN MATCHED THEN\n            UPDATE SET action_name = src.action_name  \n        WHEN NOT MATCHED THEN  \n            INSERT (action_id,action_code, action_name) \n            VALUES (src.action_id,src.action_code, src.action_name) ;\n\n\n    MERGE dbo.DimAreaOfFireOrigin AS TGT\n    USING (\n        select distinct ROW_NUMBER() OVER (ORDER BY area_code) area_id, area_code, area_name from (\n            select distinct substring(area_of_fire_origin,1,CHARINDEX('-',area_of_fire_origin)-2) area_code\n            ,substring(area_of_fire_origin,CHARINDEX('-',area_of_fire_origin)+2,LEN(area_of_fire_origin)-1) area_name \n            from dbo.Raw_FireIncidents\n            where TRIM(area_of_fire_origin) <> '-'\n        ) x\n    ) AS SRC (area_id,area_code, area_name)\n    ON TGT.area_code = SRC.area_code\n        WHEN MATCHED THEN\n            UPDATE SET area_name = src.area_name  \n        WHEN NOT MATCHED THEN  \n            INSERT (area_id, area_code, area_name) \n            VALUES (src.area_id, src.area_code, src.area_name) ;\n\n\n    MERGE dbo.FactFireIncidents AS TGT\n    USING (\n        SELECT incident_number, exposure_number, id, address, incident_date, call_number, alarm_dttm, \n            arrival_dttm, close_dttm, city, zipcode, db.battalion_id, station_area, box, suppression_units, \n            suppression_personnel, ems_units, ems_personnel, other_units, other_personnel, first_unit_on_scene, \n            estimated_property_loss, estimated_contents_loss, fire_fatalities, fire_injuries, civilian_fatalities, \n            civilian_injuries, number_of_alarms, primary_situation, mutual_aid, dap.action_id action_id_prim, das.action_id action_id_sec\n            , action_taken_other, detector_alerted_occupants, property_use, \n            daf.area_id, ignition_cause, ignition_factor_primary, ignition_factor_secondary, \n            heat_source, item_first_ignited, human_factors_associated_with_ignition, structure_type, \n            structure_status, floor_of_fire_origin, fire_spread, no_flame_spead, number_of_floors_with_minimum_damage, \n            number_of_floors_with_significant_damage, number_of_floors_with_heavy_damage, number_of_floors_with_extreme_damage, \n            detectors_present, detector_type, detector_operation, detector_effectiveness, detector_failure_reason, \n            automatic_extinguishing_system_present, automatic_extinguishing_sytem_type, automatic_extinguishing_sytem_perfomance, \n            automatic_extinguishing_sytem_failure_reason, number_of_sprinkler_heads_operating, supervisor_district, dd.district_id\n        from dbo.Raw_FireIncidents rfi\n        LEFT JOIN dbo.DimAction dap\n            on dap.action_code = case when LEN(trim(rfi.action_taken_primary)) > 3 and rfi.action_taken_primary <> '-' then substring(rfi.action_taken_primary, \n            1,case when TRIM(rfi.action_taken_primary) = '-' then 1 \n                else CHARINDEX('-',rfi.action_taken_primary)-2 end)  else '' end\n        LEFT JOIN dbo.DimAction das\n            on rfi.action_taken_secondary <> '-' and das.action_code = case when LEN(trim(rfi.action_taken_secondary)) > 3 and rfi.action_taken_primary <> '-'  then substring(rfi.action_taken_secondary,\n            1,case when TRIM(rfi.action_taken_secondary) = '-' then 1 \n                else CHARINDEX('-',rfi.action_taken_secondary)-2 end) else '' end\n        LEFT JOIN dbo.DimAreaOfFireOrigin daf\n            on daf.area_code = case when LEN(trim(rfi.area_of_fire_origin)) > 3 then substring(rfi.area_of_fire_origin,1,CHARINDEX('-',rfi.area_of_fire_origin)-2) else '' end\n        LEFT JOIN dbo.DimDistrict dd\n            on dd.district_name = rfi.neighborhood_district\n        LEFT JOIN dbo.DimBattalion db\n            on db.battalion_code = rfi.battalion\n        ) AS SRC (incident_number, exposure_number, id, address, incident_date, call_number, alarm_dttm, \n            arrival_dttm, close_dttm, city, zipcode, battalion_id, station_area, box, suppression_units, \n            suppression_personnel, ems_units, ems_personnel, other_units, other_personnel, first_unit_on_scene, \n            estimated_property_loss, estimated_contents_loss, fire_fatalities, fire_injuries, civilian_fatalities, \n            civilian_injuries, number_of_alarms, primary_situation, mutual_aid, action_id_prim, action_id_sec\n            , action_taken_other, detector_alerted_occupants, property_use, \n            area_id, ignition_cause, ignition_factor_primary, ignition_factor_secondary, \n            heat_source, item_first_ignited, human_factors_associated_with_ignition, structure_type, \n            structure_status, floor_of_fire_origin, fire_spread, no_flame_spead, number_of_floors_with_minimum_damage, \n            number_of_floors_with_significant_damage, number_of_floors_with_heavy_damage, number_of_floors_with_extreme_damage, \n            detectors_present, detector_type, detector_operation, detector_effectiveness, detector_failure_reason, \n            automatic_extinguishing_system_present, automatic_extinguishing_sytem_type, automatic_extinguishing_sytem_perfomance, \n            automatic_extinguishing_sytem_failure_reason, number_of_sprinkler_heads_operating, supervisor_district, district_id)\n    ON TGT.incident_number = SRC.incident_number\n        WHEN MATCHED THEN\n            UPDATE SET \n                exposure_number = src.exposure_number\n                , id = src.id\n                , address = src.address\n                , incident_date = src.incident_date\n                , call_number = src.call_number\n                , alarm_dttm = src.alarm_dttm\n                , arrival_dttm = src.arrival_dttm\n                , close_dttm = src.close_dttm\n                , city = src.city\n                , zipcode = src.zipcode\n                , battalion_id_fk = src.battalion_id\n                , station_area = src.station_area\n                , box = src.box\n                , suppression_units = src.suppression_units\n                , suppression_personnel = src.suppression_personnel\n                , ems_units = src.ems_units\n                , ems_personnel = src.ems_personnel\n                , other_units = src.other_units\n                , other_personnel = src.other_personnel\n                , first_unit_on_scene = src.first_unit_on_scene\n                , estimated_property_loss = src.estimated_property_loss\n                , estimated_contents_loss = src.estimated_contents_loss\n                , fire_fatalities = src.fire_fatalities\n                , fire_injuries = src.fire_injuries\n                , civilian_fatalities = src.civilian_fatalities\n                , civilian_injuries = src.civilian_injuries\n                , number_of_alarms = src.number_of_alarms\n                , primary_situation = src.primary_situation\n                , mutual_aid = src.mutual_aid\n                , action_taken_primary_id_fk = src.action_id_prim\n                , action_taken_secondary_id_fk = src.action_id_sec\n                , action_taken_other = src.action_taken_other\n                , detector_alerted_occupants = src.detector_alerted_occupants\n                , property_use = src.property_use\n                , area_of_fire_origin_id_fk = src.area_id\n                , ignition_cause = src.ignition_cause\n                , ignition_factor_primary = src.ignition_factor_primary\n                , ignition_factor_secondary = src.ignition_factor_secondary\n                , heat_source = src.heat_source\n                , item_first_ignited = src.item_first_ignited\n                , human_factors_associated_with_ignition = src.human_factors_associated_with_ignition\n                , structure_type = src.structure_type\n                , structure_status = src.structure_status\n                , floor_of_fire_origin = src.floor_of_fire_origin\n                , fire_spread = src.fire_spread\n                , no_flame_spead = src.no_flame_spead\n                , number_of_floors_with_minimum_damage = src.number_of_floors_with_minimum_damage\n                , number_of_floors_with_significant_damage = src.number_of_floors_with_significant_damage\n                , number_of_floors_with_heavy_damage = src.number_of_floors_with_heavy_damage\n                , number_of_floors_with_extreme_damage = src.number_of_floors_with_extreme_damage\n                , detectors_present = src.detectors_present\n                , detector_type = src.detector_type\n                , detector_operation = src.detector_operation\n                , detector_effectiveness = src.detector_effectiveness\n                , detector_failure_reason = src.detector_failure_reason\n                , automatic_extinguishing_system_present = src.automatic_extinguishing_system_present\n                , automatic_extinguishing_sytem_type = src.automatic_extinguishing_sytem_type\n                , automatic_extinguishing_sytem_perfomance = src.automatic_extinguishing_sytem_perfomance\n                , automatic_extinguishing_sytem_failure_reason = src.automatic_extinguishing_sytem_failure_reason\n                , number_of_sprinkler_heads_operating = src.number_of_sprinkler_heads_operating\n                , supervisor_district = src.supervisor_district\n                , neighborhood_district_id_fk = src.district_id\n        WHEN NOT MATCHED THEN  \n            INSERT (incident_number, exposure_number, id, address, incident_date, call_number, alarm_dttm, \n            arrival_dttm, close_dttm, city, zipcode, battalion_id_fk, station_area, box, suppression_units, \n            suppression_personnel, ems_units, ems_personnel, other_units, other_personnel, first_unit_on_scene, \n            estimated_property_loss, estimated_contents_loss, fire_fatalities, fire_injuries, civilian_fatalities, \n            civilian_injuries, number_of_alarms, primary_situation, mutual_aid, action_taken_primary_id_fk, \n            action_taken_secondary_id_fk, action_taken_other, detector_alerted_occupants, property_use, \n            area_of_fire_origin_id_fk, ignition_cause, ignition_factor_primary, ignition_factor_secondary, \n            heat_source, item_first_ignited, human_factors_associated_with_ignition, structure_type, \n            structure_status, floor_of_fire_origin, fire_spread, no_flame_spead, number_of_floors_with_minimum_damage, \n            number_of_floors_with_significant_damage, number_of_floors_with_heavy_damage, number_of_floors_with_extreme_damage, \n            detectors_present, detector_type, detector_operation, detector_effectiveness, detector_failure_reason, \n            automatic_extinguishing_system_present, automatic_extinguishing_sytem_type, automatic_extinguishing_sytem_perfomance, \n            automatic_extinguishing_sytem_failure_reason, number_of_sprinkler_heads_operating, supervisor_district, neighborhood_district_id_fk)\n            VALUES (src.incident_number, src.exposure_number, src.id, src.address, src.incident_date, src.call_number, src.alarm_dttm, src.\n            arrival_dttm, src.close_dttm, src.city, src.zipcode, src.battalion_id, src.station_area, src.box, src.suppression_units, src.\n            suppression_personnel, src.ems_units, src.ems_personnel, src.other_units, src.other_personnel, src.first_unit_on_scene, src.\n            estimated_property_loss, src.estimated_contents_loss, src.fire_fatalities, src.fire_injuries, src.civilian_fatalities, src.\n            civilian_injuries, src.number_of_alarms, src.primary_situation, src.mutual_aid, src.action_id_prim, src.action_id_sec\n            , src.action_taken_other, src.detector_alerted_occupants, src.property_use, src.\n            area_id, src.ignition_cause, src.ignition_factor_primary, src.ignition_factor_secondary, src.\n            heat_source, src.item_first_ignited, src.human_factors_associated_with_ignition, src.structure_type, src.\n            structure_status, src.floor_of_fire_origin, src.fire_spread, src.no_flame_spead, src.number_of_floors_with_minimum_damage, src.\n            number_of_floors_with_significant_damage, src.number_of_floors_with_heavy_damage, src.number_of_floors_with_extreme_damage, src.\n            detectors_present, src.detector_type, src.detector_operation, src.detector_effectiveness, src.detector_failure_reason, src.\n            automatic_extinguishing_system_present, src.automatic_extinguishing_sytem_type, src.automatic_extinguishing_sytem_perfomance, src.\n            automatic_extinguishing_sytem_failure_reason, src.number_of_sprinkler_heads_operating, src.supervisor_district, src.district_id)\n            ;\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "SQLPoolTest",
				"poolName": "SQLPoolTest"
			},
			"resultLimit": -1
		},
		"type": "SqlQuery"
	}
}